# AI-Server 开发进度与待办（Win10）

更新时间：2025-08-24 02:01 (本地)
仓库：`c:/code/ai-server`
权威文档：
- `doc/AI-Server-编排设计与实施方案.md`
- `doc/AI-Server-实现规范与接口契约.md`
- `doc/脚本使用手册.md`

---

## 一、当前开发进度概览

- 环境与运行
  - package 脚本具备：`dev:all`、`build`、`dist`，基于 tsup + vite + electron-builder，Win10 兼容良好。
  - `npm run dev:all` 已实现并行 main/renderer/electron（`concurrently` + 自定义 `start-electron.cjs`）。
- 配置与注册表（主进程）
  - `src/main/config/schema.ts`：已定义模块 Schema、健康检查、全局配置与校验函数（含循环依赖检测）。
  - `src/main/config/store.ts`：已实现注册表加载（内置 `src/main/config/registry/*.json` + 用户覆盖 `userData/modules/*.json`）、全局配置读写、first-run 状态读写、缓存。
- Docker 编排
  - `src/main/docker/index.ts`：已实现 `list/start/stop/status/firstStart` 与对应 Stream 版本；端口占用检测、健康等待（tcp/http/container_healthy）、依赖拓扑启动、已存在容器“直接 docker start”优化、日志回传（一次性与实时流）。
  - `src/main/docker/utils.ts`：已实现 compose 可用性检测、Docker 运行/版本检测、tcp/http 等待、端口探测，均为 Win10 兼容实现。
  - `orchestration/infra/docker-compose.infra.yml`：存在，用于基础服务启动。
- IPC 契约与通道
  - 契约：`src/shared/ipc-contract.ts` 已定义基础类型、IPC 事件、`ModuleStatus` 等；但错误码未统一枚举化。
  - 通道：`src/main/ipc/modules.ts`、`config.ts`、`docker.ts`、`env.ts` 已存在。`modules.ts` 已接入 start/stop/status/firstStart 及流式日志 IPC。
- 渲染端最小 UI
  - `src/renderer/pages/Home.vue`：具备 EnvCard 占位、模块 Tabs 列表（Basic/Feature）、Start/Stop/Clear/FirstStart 操作、轮询状态、配置项“日志输出到 console”。
  - 组件：`EnvCard.vue`、`ModuleList.vue`、`LogsPanel.vue` 均存在；LogsPanel 当前为占位，未在 Home 中集成入口。
- 脚本与运行（PowerShell）
  - `scripts/module.ps1` 存在，`scripts/modules/mysql|redis|oneapi` 子脚本存在（start/stop/status/clear-data）。
  - 提供 `first-run-simulate.ps1`、`reset-first-run.ps1` 与 tests 脚本（redis/mysql）。

---

## 二、与“必做任务清单”的对照

- 1) 主进程配置与注册表
  - schema.ts：已完成主要结构与校验（与文档第6章基本一致）。
  - store.ts：已完成加载/合并/缓存与 first-run 状态读写。依赖图缓存已隐含（`validateRegistry` 可提供），但尚未落盘为“依赖图缓存文件”。
  - 首次启动：已提供 `firstStartModule`/Stream，具备外部资源创建（网络/卷）与后续启动；但未覆盖完整错误码与回滚策略。
- 2) Docker 启停编排
  - `index.ts`：已实现大部分逻辑（依赖拓扑、端口检测、健康等待）。
  - `template.ts`：缺失。尚未实现 compose `templateRef|fragment` 渲染与变量合并、Windows 路径规范化。
  - `utils.ts`：基础工具已具备，缺少统一错误码与版本对齐校验（如 `E_COMPOSE_NOT_FOUND` 显式返回）。
- 3) 首次启动流程
  - 基础步骤已覆盖（预检/镜像准备部分简单化，依赖启动/健康等待已做）。
  - 未实现：镜像拉取失败重试、初始化/迁移脚本执行、失败回滚与幂等标记的完整策略，错误码映射未齐。
- 4) IPC 契约与通道
  - `ipc-contract.ts`：缺少错误码常量与更细的数据结构（如 `EnvDiagnoseResult` 中 issues 的结构化分级）。
  - 主进程 IPC：`modules.ts`、`config.ts` 已覆盖核心；`docker.ts`、`env.ts` 未审阅细节但文件存在。
- 5) 渲染端最小 UI
  - Home 页面与基础组件已具备；首次启动向导（进度可视化、错误码提示、查看日志入口）尚未实现。
  - 端口设置弹窗与异步占用校验：当前通过后端校验，前端未提供端口编辑 UI。
  - LogsPanel 未与操作流整合（仅 console 输出）。
- 6) 脚本与运行
  - `package.json` 已满足 `dev:all`、`build`；`dist` 已配置（可选）。
  - README Windows 运行说明未见专门补充（可在后续完善）。

- 11) 测试清单
  - 部分可触发：`E_COMPOSE_NOT_FOUND`、`E_PORT_CONFLICT`、`E_HEALTH_TIMEOUT` 能以当前实现近似覆盖但未以统一错误码返回。
  - 未覆盖或未显式：`E_TEMPLATE_MISSING`、`E_VAR_MISSING`、`E_DEP_CYCLE`（校验函数有检测，但 IPC 返回未统一）、`E_PREFLIGHT_RESOURCE`、`E_EXT_CONN_FAIL`、`E_IMAGE_PULL`、`E_INIT_SCRIPT`、`E_FIRST_RUN_ABORTED`。

---

## 三、风险与兼容性

- Windows 兼容：当前编排命令均通过 `shell:true` 与纯 docker/compose 命令，未依赖 bash；端口探测基于 Node `net`，OK。
- 错误码与契约：返回多为 message 文本，缺少标准化错误码，影响 UI 指引与自动化测试对齐文档。
- 模块模板渲染：未实现 `template.ts`，后续多模块落地会受限。

---

## 四、下一步待办（按优先级）

- P0（本周完成）
  - 错误码标准化：在 `src/shared/ipc-contract.ts` 增补错误码常量与类型，在 `docker/index.ts`、`config/store.ts` 等返回结构中贯彻。
  - 模板渲染：新增 `src/main/docker/template.ts`，实现 `templateRef|fragment` 渲染、变量合并、Windows 路径正斜杠化；缺失模板时报 `E_TEMPLATE_MISSING`、变量缺失报 `E_VAR_MISSING`。
  - 首次启动流程强化：镜像拉取重试、初始化脚本（可先占位）执行、失败回滚与 `firstRunDone` 幂等；补齐 `E_PREFLIGHT_RESOURCE/E_EXT_CONN_FAIL/E_IMAGE_PULL/E_INIT_SCRIPT/E_FIRST_RUN_ABORTED`。
  - UI 首启向导：在 `Home.vue` 集成向导对话框（进度条、错误码展示、日志入口），串联 `FirstStartStream`。

- P1
  - 端口设置弹窗：模块行上增加“配置端口”入口，实时校验（调用后端 `isTcpOpen` IPC 或新增 `PortCheck` IPC）。
  - LogsPanel 集成：为每次操作提供“查看日志”面板，支持实时与历史两种来源。
  - 依赖图缓存：将 `validateRegistry` 结果落盘到 `userData/registry-cache.json`，便于诊断与 UI 展示。

- P2
  - README（Windows）使用说明与故障排查章节补齐。
  - 外部依赖开关（useExternalDB/Redis）：在 registry 与模板层支持，并在 `start()` 按开关调整依赖。
  - 健康检查扩展：容器 `Healthcheck` 失败原因提取与超时策略细化。

---

## 五、当前运行与脚本

- 启动开发：`npm i && npm run dev:all`
- 打包：`npm run build`（产物：`out/main` + `dist/renderer`）; `npm run dist`（可选，electron-builder）
- PowerShell：
  - 统一调度：`scripts/module.ps1 -Name <ModuleName> -Action start|stop|status|clear [-Force]`
  - 子模块脚本：`scripts/modules/<module>/start.ps1|stop.ps1|status.ps1|clear-data.ps1`

---

## 六、验收与测试对齐建议

- 在 `IPC` 层新增 `code` 字段并统一错误码，前端根据错误码提供引导与诊断入口。
- 新增最小注册表样例（1-2 个基础服务 + 1 个功能模块）自测链路，完善 `scripts/tests/*`。
- 对文档第11章的每个错误码补充触发路径与复现脚本（Win10）。

---

如需我继续补齐 `template.ts` 与错误码统一，请在我这份清单基础上确认优先级与验收口径。
