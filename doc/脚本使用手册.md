# 脚本使用手册（Windows PowerShell）

本页记录仓库内所有 PowerShell 脚本的用途与用法，便于本地人工/CI 调用。

注意：根据《AI-Server-实现规范与接口契约》，UI 渲染进程禁止直接调用这些脚本；UI 通过主进程 IPC 完成容器管理。本手册仅面向人工或 CI 使用。

---

## 0. 运行环境
- Windows 10/11 + PowerShell
- 已安装并运行 Docker Desktop（或兼容的 Docker 环境）
- 建议以非管理员身份运行；需要时 PowerShell 执行策略可设置：`-ExecutionPolicy Bypass`

通用调用模板：
```powershell
powershell -NoProfile -ExecutionPolicy Bypass -File <脚本路径> [参数]
```

---

## 1. 统一调度脚本：`scripts/module.ps1`
用于统一调用模块级脚本（start/stop/status/clear）。UI 不调用该脚本。

参数：
- `-Name <string>`：模块名，当前支持：`mysql`、`redis`、`qdrant`、`dify`、`ragflow`
- `-Action <start|stop|status|clear>`：执行动作
- `-Force`：在 `-Action clear` 时跳过二次确认
- `-ApiPort <int>`：可选，传递给部分模块（如 `dify`）的 API 端口，对应模块 `start.ps1` 的 `-ApiPort`

示例：
```powershell
# 启动 MySQL
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/module.ps1 -Name mysql -Action start

# 停止 Redis
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/module.ps1 -Name redis -Action stop

# 清理 MySQL（容器/卷/网络）并跳过确认
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/module.ps1 -Name mysql -Action clear -Force
```

---

## 2. 模块级脚本
每个模块位于 `scripts/modules/<module>/` 目录下，提供独立的操作脚本。

### 2.1 MySQL（`scripts/modules/mysql/`）
- `start.ps1`
  - 作用：
    - 若容器不存在：创建 Docker 网络/卷，`docker run` 启动容器
    - 若容器存在：直接 `docker start`
    - 等待端口就绪（默认 `127.0.0.1:13306`）
  - 参数：
    - `-BindAddress`（默认 `127.0.0.1`）
    - `-HostPort`（默认 `13306`）
    - `-RootPassword`（默认 `root`）
  - 示例：
    ```powershell
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/mysql/start.ps1 -HostPort 23306
    ```
- `stop.ps1`
  - 作用：若容器在运行则停止
  - 示例：
    ```powershell
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/mysql/stop.ps1
    ```
- `status.ps1`（占位）
- `clear-data.ps1`
  - 作用：按需清理 MySQL 的容器/卷/网络（不删除镜像）
  - 参数（可组合）：
    - `-All`：清理容器+卷+网络（默认行为，若未显式指定其它开关）
    - `-Containers`：仅清理容器
    - `-Volumes`：仅清理卷
    - `-Networks`：仅清理网络
    - `-Force`：跳过二次确认
  - 安全提示：当目标网络被其它容器占用（非本模块容器）时，会自动跳过网络删除并给出提示，避免影响仍在使用该网络的服务。
  - 示例：
    ```powershell
    # 默认等价于 -All：容器+卷+网络
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/mysql/clear-data.ps1

    # 仅清理容器
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/mysql/clear-data.ps1 -Containers -Force

    # 仅清理卷与网络
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/mysql/clear-data.ps1 -Volumes -Networks

    # 若不希望影响共享网络，仅清理容器与卷
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/mysql/clear-data.ps1 -Containers -Volumes
    ```

### 2.2 Redis（`scripts/modules/redis/`）
- `start.ps1`
  - 作用：同 MySQL，默认端口 `127.0.0.1:16379`
  - 参数：
    - `-BindAddress`（默认 `127.0.0.1`）
    - `-HostPort`（默认 `16379`）
- `stop.ps1`
  - 作用：若容器在运行则停止
- `status.ps1`（占位）
- `clear-data.ps1`
  - 参数与 MySQL 一致（`-All`、`-Containers`、`-Volumes`、`-Networks`、`-Force`）
  - 安全提示：当目标网络被其它容器占用（非本模块容器）时，会自动跳过网络删除并给出提示。

### 2.3 Qdrant（`scripts/modules/qdrant/`）
- `start.ps1`
  - 作用：
    - 若容器不存在：创建 Docker 网络/卷，`docker run` 启动容器
    - 若容器存在：直接 `docker start`
    - 等待 HTTP 健康检查就绪（默认 `127.0.0.1:16333/health`）
  - 参数：
    - `-BindAddress`（默认 `127.0.0.1`）
    - `-HostPort`（默认 `16333`）
  - 示例：
    ```powershell
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/qdrant/start.ps1 -HostPort 16334
    ```
- `stop.ps1`
  - 作用：若容器在运行则停止
  - 示例：
    ```powershell
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/qdrant/stop.ps1
    ```
- `status.ps1`
  - 作用：显示容器状态、端口映射与 HTTP 健康检查结果
  - 参数：
    - `-BindAddress`（默认 `127.0.0.1`）
    - `-HostPort`（默认 `16333`）
- `clear-data.ps1`
  - 作用：按需清理 Qdrant 的容器/卷/网络（不删除镜像）
  - 参数与 MySQL 一致（`-All`、`-Containers`、`-Volumes`、`-Networks`、`-Force`）
  - 安全提示：当目标网络被其它容器占用时，会自动跳过网络删除并给出提示

示例：
```powershell
# 启动 Redis 并等待端口就绪
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/redis/start.ps1

# 仅清理 Redis 卷
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/redis/clear-data.ps1 -Volumes

# 仅清理 Redis 容器与卷（不尝试删网络）
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/redis/clear-data.ps1 -Containers -Volumes
```

### 2.4 Dify（`scripts/modules/dify/`）
- 启动脚本：`start.ps1`
  - 行为：
    - 确保外部网络 `ai-server-net` 存在
    - 通过 compose 启动 `dify-api` 与 `dify-web`（`--no-recreate` 幂等）
    - 默认开启数据库迁移：设置 `MIGRATION_ENABLED=true`，容器内自动执行 Alembic（等价 `flask db upgrade`）
  - 关键环境变量（可通过环境传入覆盖）：
    - `DIFY_SECRET_KEY`（默认 `please-change-me`，建议修改）
    - `DIFY_WEB_PORT`（默认 `18090`）
    - `DIFY_API_PORT`（默认 `18091`）
  - 依赖前置（必须已运行且在同一网络）：
    - Postgres（容器名 `ai-postgres`，服务名 `postgres`）
    - Redis（容器名 `ai-redis`，服务名 `redis`）
    - Qdrant（容器名 `ai-qdrant`，服务名 `qdrant`）
  - 直接用法（依赖已运行）：
    ```powershell
    ./scripts/module.ps1 -Name dify -Action start -ApiPort 18091
    ```
  - 一次到位（推荐顺序）：
    ```powershell
    # 1) 网络（如未创建过）
    docker network ls --format '{{.Name}}' | findstr /i ai-server-net || docker network create ai-server-net

    # 2) 基础设施（Postgres + Redis + Qdrant）
    docker compose -f orchestration/infra/docker-compose.infra.yml up -d postgres redis qdrant

    # 3) 启动 Dify（会自动迁移）
    ./scripts/module.ps1 -Name dify -Action start -ApiPort 18091
    ```
  - 端口：
    - Web: `127.0.0.1:${DIFY_WEB_PORT:-18090} -> 3000`
    - API: `127.0.0.1:${DIFY_API_PORT:-18091} -> 5001`
  - 容器：
    - `ai-dify-api`（镜像 `langgenius/dify-api:1.7.2`）
    - `ai-dify-web`（镜像 `langgenius/dify-web:1.7.2`）
  - 迁移说明：
    - 已开启 `MIGRATION_ENABLED=true`，对已有数据执行“增量迁移”，正常不丢数据；仍建议在生产前做数据库快照/备份
  - 常见问题：
    - API 日志报错 `relation "dify_setups" does not exist`：说明迁移未成功执行；可进入容器手动执行 `flask db upgrade` 后重启
    - 连接数据库失败：确认 `ai-postgres` 与 `ai-redis` 已运行并加入 `ai-server-net` 网络

---

### 2.4 n8n（通过 compose 启动）
- 依赖前置：
  - Postgres（容器名 `ai-postgres`）
  - Redis（容器名 `ai-redis`）
- 端口：
  - Web/API: `127.0.0.1:${N8N_PORT:-18100} -> 5678`
- 容器：`ai-n8n`（镜像 `n8nio/n8n:latest`）
- 快速启动：
  ```powershell
  # 确保网络与依赖
  docker network ls --format '{{.Name}}' | findstr /i ai-server-net || docker network create ai-server-net
  docker compose -f orchestration/infra/docker-compose.infra.yml up -d --no-recreate postgres redis

  # 启动 n8n
  docker compose -f orchestration/modules/n8n/docker-compose.feature.yml up -d --no-recreate n8n
  ```
- 停止/日志：
  ```powershell
  docker compose -f orchestration/modules/n8n/docker-compose.feature.yml stop n8n
  docker logs -f ai-n8n
  ```
- 可覆盖的常用环境：`N8N_PORT`、`N8N_DB_*`、`N8N_REDIS_*`（见 `orchestration/modules/n8n/docker-compose.feature.yml`）

---

### 2.5 RagFlow（`scripts/modules/ragflow/`）
- `start.ps1`
  - 作用：
    - 确保外部网络 `ai-server-net` 存在
    - 检查依赖服务健康状态（MySQL、Redis、MinIO、Elasticsearch）
    - 通过 compose 启动 `ragflow` 和 `mysql-init`（`--no-recreate` 幂等）
    - 等待 Web 界面就绪（默认 `127.0.0.1:18600`）
  - 参数：
    - `-BindAddress`（默认 `127.0.0.1`）
    - `-HostPort`（默认 `18600`）
    - `-DocEngine`（默认 `elasticsearch`）
    - `-MySQLHost`、`-MySQLPort`、`-MySQLUser`、`-MySQLPass`（默认连接本地基础设施）
    - `-RedisHost`、`-RedisPort`（默认连接本地基础设施）
    - `-MinioHost`、`-MinioPort`（默认连接本地基础设施）
    - `-ESHost`、`-ESPort`（默认连接本地基础设施）
  - 依赖前置（必须运行且在同一网络）：
    - MySQL（`ai-mysql`，root/root）
    - Redis（`ai-redis`，无密码）
    - MinIO（`ai-minio`，默认 `rag_flow/infini_rag_flow`）
    - Elasticsearch（`ai-elasticsearch`，默认 `elastic/infini_rag_flow`）
  - 端口：
    - Web/API: `127.0.0.1:${RAGFLOW_PORT:-18600} -> 9380`
  - 容器：`ai-ragflow`（镜像 `infiniflow/ragflow:v0.20.3-slim`）
  - 示例：
    ```powershell
    # 启动 RagFlow 并等待端口就绪
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/ragflow/start.ps1
    
    # 启动 RagFlow 使用自定义端口
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/ragflow/start.ps1 -HostPort 18601
    
    # 一次到位（推荐顺序）：
    # 1) 确保网络与依赖
    docker network ls --format '{{.Name}}' | findstr /i ai-server-net || docker network create ai-server-net
    docker compose -f orchestration/infra/docker-compose.infra.yml up -d --no-recreate mysql redis minio elasticsearch
    
    # 2) 启动 RagFlow
    ./scripts/module.ps1 -Name ragflow -Action start
    ```
  - 重要说明与排障：
    - 该模块通过只读挂载 `service_conf.yaml.template` 到容器 `/ragflow/conf/service_conf.yaml.template`，容器启动脚本会据此生成最终的 `service_conf.yaml`。请勿直接覆盖 `/ragflow/conf/service_conf.yaml`。
    - 若曾修改过 compose 配置（卷/环境变量），需要删除旧容器以应用新配置：`docker rm -f ai-ragflow` 后再 `up -d`。
    - 默认环境与基础设施对齐：`MYSQL_USER=root`、`MYSQL_PASSWORD=root`、`REDIS_PASSWORD` 为空；ES 使用 `ELASTIC_PASSWORD=infini_rag_flow`。
    - 启动时会自动创建 `rag_flow` 数据库（通过 `mysql-init` 服务）

- `stop.ps1`
  - 作用：停止 RagFlow 相关容器（`ai-ragflow` 和 `ai-ragflow-mysql-init`）
  - 示例：
    ```powershell
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/ragflow/stop.ps1
    ```

- `status.ps1`
  - 作用：
    - 显示 RagFlow 容器状态
    - 检查 HTTP 健康状态
    - 显示依赖服务状态
    - 显示网络和端口信息
  - 参数：
    - `-BindAddress`（默认 `127.0.0.1`）
    - `-HostPort`（默认 `18600`）
  - 示例：
    ```powershell
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/ragflow/status.ps1
    ```

- `clear-data.ps1`
  - 作用：清理 RagFlow 的容器和相关数据
  - 参数：
    - `-Force`：跳过二次确认
  - 安全提示：
    - 会停止并删除 RagFlow 容器
    - 会清理相关的数据卷（如果存在）
    - 不会删除共享的基础设施卷（如 `ai-server-mysql-data` 等）
    - 使用 `reset-first-run.ps1` 可清理所有基础设施
  - 示例：
    ```powershell
    # 清理 RagFlow 容器和数据（需要确认）
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/ragflow/clear-data.ps1
    
    # 强制清理（跳过确认）
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/ragflow/clear-data.ps1 -Force
    ```

## 3. 首次启动模拟：`scripts/first-run-simulate.ps1`
- 作用：模拟“新用户第一次启动”场景
  - 删除 ai-server 相关容器、卷、网络（不删除任何镜像）
  - 依次启动基础服务：MySQL、Redis
  - 可选启动 `oneapi`
- 参数：
  - `-IncludeOneApi`：包含 OneAPI 的清理与启动
  - `-Force`：跳过二次确认
- 示例：
```powershell
# 基础（MySQL + Redis）
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/first-run-simulate.ps1

# 包含 OneAPI，且跳过确认
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/first-run-simulate.ps1 -IncludeOneApi -Force
```

---

## 4. 测试脚本
- `scripts/tests/test-mysql.ps1`：启动→探活(13306)→停止
- `scripts/tests/test-redis.ps1`：启动→探活(16379)→停止

示例：
```powershell
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/tests/test-mysql.ps1
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/tests/test-redis.ps1
```

---

## 5. 首次运行重置：`scripts/reset-first-run.ps1`
- 作用：一键删除 ai-server 相关容器、命名卷与外部网络（不删除镜像），将本机恢复到“已安装 Docker，但从未运行过本软件”的初始状态。
- 参数：
  - `-IncludeModules`：参数存在但当前实现中未被实际使用；脚本会无条件清理所有以 `ai-` 开头的容器（包含功能模块）。后续将修正脚本逻辑以与参数语义一致。
  - `-Force`：跳过二次确认
- 编码/执行策略：
  - 如遇中文乱码或解析错误，使用以下方式调用，强制无配置+绕过策略：
  ```powershell
  powershell -NoProfile -ExecutionPolicy Bypass -File scripts/reset-first-run.ps1
  ```
  - 若仍异常，请确保 PowerShell 的执行策略允许本地脚本：
    ```powershell
    Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy RemoteSigned
    ```
- 示例：
```powershell
# 仅清空基础服务（MySQL、Redis）容器/卷/网络
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/reset-first-run.ps1

# 同时清理所有以 ai- 开头的功能模块容器，并跳过确认
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/reset-first-run.ps1 -IncludeModules -Force
```

---

## 6. 约定与资源命名
- 网络：`ai-server-net`
- 卷：
  - MySQL：`ai-server-mysql-data`
  - Redis：`ai-server-redis-data`
  - Qdrant：`ai-server-qdrant-data`
- 容器：
  - MySQL：`ai-mysql`
  - Redis：`ai-redis`
  - Qdrant：`ai-qdrant`
  - n8n：`ai-n8n`
  - RagFlow：`ai-ragflow`

以上脚本不会删除任何镜像；仅在清理时删除容器/卷/网络。

---

## 附：直接使用 Docker/Compose 命令

以下命令用于无需 PowerShell 脚本、直接用 Docker/Compose 启动基础服务与模块，便于排障或 CI。

- 外部资源（需预先创建，compose 文件中以 external 引用）
```powershell
docker network create ai-server-net
docker volume create ai-server-mysql-data
docker volume create ai-server-redis-data
docker volume create ai-server-es-data
docker volume create ai-server-minio-data
docker volume create ai-server-logs
```

- 启动基础服务（MySQL + Redis）
```powershell
docker compose -f orchestration/infra/docker-compose.infra.yml up -d --no-recreate mysql redis
```

- 启动 OneAPI 模块
```powershell
docker compose -f orchestration/modules/oneapi/docker-compose.feature.yml up -d --no-recreate oneapi
```

- 停止/查看
```powershell
docker compose -f orchestration/infra/docker-compose.infra.yml stop mysql redis
docker compose -f orchestration/modules/oneapi/docker-compose.feature.yml stop oneapi
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
```

- 启动 n8n 模块
```powershell
docker compose -f orchestration/modules/n8n/docker-compose.feature.yml up -d --no-recreate n8n
```

- 启动 RagFlow 模块
```powershell
docker compose -f orchestration/modules/ragflow/docker-compose.feature.yml up -d --no-recreate ragflow
```

- 停止 n8n / RagFlow
```powershell
docker compose -f orchestration/modules/n8n/docker-compose.feature.yml stop n8n
docker compose -f orchestration/modules/ragflow/docker-compose.feature.yml stop ragflow
```

说明：compose 文件中使用了 `${VAR-default}` 形式的默认值（例如 `BIND_ADDRESS`、各宿主端口），可通过 `.env` 或环境变量覆盖。

## 8. 常见错误码与退出码

- `E_TEMPLATE_MISSING`：所需的 compose 模板缺失（例如路径不正确或文件不存在）。
- `E_HEALTH_TIMEOUT`：健康检查（TCP/HTTP）在规定时间内未就绪。
- `E_RUNTIME`：运行时失败（如 `docker compose up` 返回非零）。

退出码约定：
- 成功：`0`
- 参数/环境错误（如未安装 Docker）：`2`
- 健康检查超时：`3`
- 模板缺失等前置错误：`4`
- 运行时错误：`5`

## 7. RagFlow 完整使用示例

以下是一个完整的 RagFlow 使用示例，展示如何从零开始启动和管理服务：

```powershell
# 1. 清理环境（如果需要）
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/reset-first-run.ps1 -Force

# 2. 启动基础设施服务
docker network ls --format '{{.Name}}' | findstr /i ai-server-net || docker network create ai-server-net
docker volume create ai-server-mysql-data
docker volume create ai-server-redis-data
docker volume create ai-server-es-data
docker volume create ai-server-minio-data
docker volume create ai-server-logs

docker compose -f orchestration/infra/docker-compose.infra.yml up -d --no-recreate mysql redis minio elasticsearch

# 3. 等待基础设施服务启动完成
Start-Sleep -Seconds 10

# 4. 启动 RagFlow
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/ragflow/start.ps1

# 5. 检查状态
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/ragflow/status.ps1

# 6. 停止服务
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/ragflow/stop.ps1

# 7. 清理数据（如果需要）
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/ragflow/clear-data.ps1 -Force
```
