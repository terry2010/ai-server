# 脚本使用手册（Windows PowerShell）

本页记录仓库内所有 PowerShell 脚本的用途与用法，便于本地人工/CI 调用。

注意：根据《AI-Server-实现规范与接口契约》，UI 渲染进程禁止直接调用这些脚本；UI 通过主进程 IPC 完成容器管理。本手册仅面向人工或 CI 使用。

---

## 0. 运行环境
- Windows 10/11 + PowerShell
- 已安装并运行 Docker Desktop（或兼容的 Docker 环境）
- 建议以非管理员身份运行；需要时 PowerShell 执行策略可设置：`-ExecutionPolicy Bypass`

通用调用模板：
```powershell
powershell -NoProfile -ExecutionPolicy Bypass -File <脚本路径> [参数]
```

---

## 1. 统一调度脚本：`scripts/module.ps1`
用于统一调用模块级脚本（start/stop/status/clear）。UI 不调用该脚本。

参数：
- `-Name <string>`：模块名，当前支持：`mysql`、`redis`、（后续将支持 `oneapi` 等）
- `-Action <start|stop|status|clear>`：执行动作
- `-Force`：在 `-Action clear` 时跳过二次确认

示例：
```powershell
# 启动 MySQL
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/module.ps1 -Name mysql -Action start

# 停止 Redis
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/module.ps1 -Name redis -Action stop

# 清理 MySQL（容器/卷/网络）并跳过确认
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/module.ps1 -Name mysql -Action clear -Force
```

---

## 2. 模块级脚本
每个模块位于 `scripts/modules/<module>/` 目录下，提供独立的操作脚本。

### 2.1 MySQL（`scripts/modules/mysql/`）
- `start.ps1`
  - 作用：
    - 若容器不存在：创建 Docker 网络/卷，`docker run` 启动容器
    - 若容器存在：直接 `docker start`
    - 等待端口就绪（默认 `127.0.0.1:13306`）
  - 参数：
    - `-BindAddress`（默认 `127.0.0.1`）
    - `-HostPort`（默认 `13306`）
    - `-RootPassword`（默认 `root`）
  - 示例：
    ```powershell
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/mysql/start.ps1 -HostPort 23306
    ```
- `stop.ps1`
  - 作用：若容器在运行则停止
  - 示例：
    ```powershell
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/mysql/stop.ps1
    ```
- `status.ps1`（占位）
- `clear-data.ps1`
  - 作用：按需清理 MySQL 的容器/卷/网络（不删除镜像）
  - 参数（可组合）：
    - `-All`：清理容器+卷+网络（默认行为，若未显式指定其它开关）
    - `-Containers`：仅清理容器
    - `-Volumes`：仅清理卷
    - `-Networks`：仅清理网络
    - `-Force`：跳过二次确认
  - 安全提示：当目标网络被其它容器占用（非本模块容器）时，会自动跳过网络删除并给出提示，避免影响仍在使用该网络的服务。
  - 示例：
    ```powershell
    # 默认等价于 -All：容器+卷+网络
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/mysql/clear-data.ps1

    # 仅清理容器
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/mysql/clear-data.ps1 -Containers -Force

    # 仅清理卷与网络
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/mysql/clear-data.ps1 -Volumes -Networks

    # 若不希望影响共享网络，仅清理容器与卷
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/mysql/clear-data.ps1 -Containers -Volumes
    ```

### 2.2 Redis（`scripts/modules/redis/`）
- `start.ps1`
  - 作用：同 MySQL，默认端口 `127.0.0.1:16379`
  - 参数：
    - `-BindAddress`（默认 `127.0.0.1`）
    - `-HostPort`（默认 `16379`）
- `stop.ps1`
  - 作用：若容器在运行则停止
- `status.ps1`（占位）
- `clear-data.ps1`
  - 参数与 MySQL 一致（`-All`、`-Containers`、`-Volumes`、`-Networks`、`-Force`）
  - 安全提示：当目标网络被其它容器占用（非本模块容器）时，会自动跳过网络删除并给出提示。

示例：
```powershell
# 启动 Redis 并等待端口就绪
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/redis/start.ps1

# 仅清理 Redis 卷
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/redis/clear-data.ps1 -Volumes

# 仅清理 Redis 容器与卷（不尝试删网络）
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/modules/redis/clear-data.ps1 -Containers -Volumes
```

---

## 3. 首次启动模拟：`scripts/first-run-simulate.ps1`
- 作用：模拟“新用户第一次启动”场景
  - 删除 ai-server 相关容器、卷、网络（不删除任何镜像）
  - 依次启动基础服务：MySQL、Redis
  - 可选启动 `oneapi`
- 参数：
  - `-IncludeOneApi`：包含 OneAPI 的清理与启动
  - `-Force`：跳过二次确认
- 示例：
```powershell
# 基础（MySQL + Redis）
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/first-run-simulate.ps1

# 包含 OneAPI，且跳过确认
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/first-run-simulate.ps1 -IncludeOneApi -Force
```

---

## 4. 测试脚本
- `scripts/tests/test-mysql.ps1`：启动→探活(13306)→停止
- `scripts/tests/test-redis.ps1`：启动→探活(16379)→停止

示例：
```powershell
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/tests/test-mysql.ps1
powershell -NoProfile -ExecutionPolicy Bypass -File scripts/tests/test-redis.ps1
```

---

## 5. 约定与资源命名
- 网络：`ai-server-net`
- 卷：
  - MySQL：`ai-server-mysql-data`
  - Redis：`ai-server-redis-data`
- 容器：
  - MySQL：`ai-mysql`
  - Redis：`ai-redis`

以上脚本不会删除任何镜像；仅在清理时删除容器/卷/网络。
