# AI-Server 今日待办（Win10）- 2025-08-24

仓库：`c:/code/ai-server`
权威文档：`doc/AI-Server-编排设计与实施方案.md`、`doc/AI-Server-实现规范与接口契约.md`、`doc/脚本使用手册.md`

---

## 一、今日目标（P0）
- 将 Dify 以“最小可运行”形态纳入模块编排：注册表、模板渲染、启停、健康检查、脚本四件套。
- 通过 UI 完成列表展示与 Start/Stop/Status/Clear 基本链路（可暂不含首启迁移脚本）。
- 保证 Win10 一键运行：`npm i && npm run dev:all`。

## 二、验收标准
- Home 页面出现 `dify` 模块（type=feature），可 Start/Stop/Status/查看日志；错误码对齐共享契约。
- `scripts/module.ps1 -Name dify -Action start|stop|status|clear` 可用；`clear-data.ps1` 必备，失败返回非零码。
- 编排侧：端口冲突检测有效；健康检查通过（http 或 tcp）。
- 首启流程：保留入口但允许“跳过迁移脚本”，错误码预留（E_IMAGE_PULL/E_INIT_SCRIPT）。

## 今日进展
- [完成] 集成 Dify 启动时自动迁移：
  - `orchestration/modules/dify/docker-compose.feature.yml` 增加 `MIGRATION_ENABLED: "true"` 与默认 `SECRET_KEY`
  - `scripts/modules/dify/start.ps1` 默认开启迁移并透传 `DIFY_SECRET_KEY`
  - 文档已补充：`doc/脚本使用手册.md`、`doc/AI-Server-编排设计与实施方案.md`
- [完成] 明确依赖启动顺序：先 infra（Postgres/Redis），再 Dify 模块
- [待验证] UI `Home.vue` 出现 dify 并可操作（Start/Stop/Status/Logs）

## 后续安排
- UI 验证与联调（Home 列表与操作链路）
- 首启流程与错误码补齐：`E_IMAGE_PULL`、`E_INIT_SCRIPT` 等占位与回滚策略

## 三、任务拆解
- P0（今日完成）
  1) 注册表与模板
     - 在 `src/main/config/registry/` 增加 `dify.json`（feature，dependsOn: mysql/redis 等按文档）
     - 在 `src/main/docker/template.ts` 兼容 `dify` 变量与路径正斜杠化（如需新增变量默认值）
     - 健康检查：优先 http(`http://127.0.0.1:<port>/health` 或 web ui 200)；端口暴露与占用检测
  2) 启停编排
     - `src/main/docker/index.ts`：确保 `start/stop/status/clear/firstStart` 对 `dify` 无特判即可工作
     - `src/main/docker/utils.ts`：复用现有端口检测/compose 可用性
  3) IPC 与 UI
     - `src/shared/ipc-contract.ts`：如需为 `EnvDiagnoseResult.issues` 结构化，今日仅保持 string[]（与现状一致）
     - `src/renderer/pages/Home.vue`、`components/ModuleList.vue`：模块行显示 dify，与现有按钮复用
  4) 脚本
     - 新建 `scripts/modules/dify/{start.ps1,stop.ps1,status.ps1,clear-data.ps1}`，遵循脚本手册

- P1（可顺延）
  - 首次启动向导串联 `ModuleFirstStartStream`，镜像拉取重试与迁移脚本占位（返回标准错误码）
  - `scripts/tests/*` 增加 dify 端到端脚本（状态/端口/健康）

## 四、风险与依赖
- 端口：可能与本机已有服务冲突，需允许修改宿主机端口并进行占用校验（后端已有）
- 资源：初次拉取镜像体积大，需显式提示进度与重试（P1 处理）
- 外部依赖：是否复用 `mysql`/`redis` 基础服务，按权威文档开关处理（今日默认内部）

## 五、实施顺序与时间盒（今日）
- 09:30-10:10 注册表与模板落地（dify.json + 变量校验）
- 10:10-11:00 编排与健康检查打通（start/stop/status/clear）
- 11:00-11:40 PS 脚本四件套（含 `-Force` 清理）
- 11:40-12:00 UI 验证与联调（错误码弹窗）
- 14:00-15:00 端到端自测与修复

## 六、提交规范
- feat(dify): registry + compose template + healthcheck
- chore(scripts): add dify ps scripts
- fix(docker): health wait edge cases (if any)
- docs(todo): 更新今日进度与下一步

## 七、后续跟进
- 扩展 `EnvDiagnoseResult.issues` 为结构化对象
- `first-run` 迁移脚本占位与回滚策略
- 外部依赖开关（useExternalDB/Redis）在 `dify` 的适配
