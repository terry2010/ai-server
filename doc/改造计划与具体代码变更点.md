# AI-Server 升级改造计划（dockerode-only）

本计划将当前项目改造成严格遵循《复刻 AI-Server（Electron + Vue3 + Docker 管理）生成式开发 Prompt》要求的实现，核心目标：仅用 dockerode 实现容器生命周期、状态与日志，去除对 docker/docker-compose CLI 的依赖；补齐 Orchestration 目录结构与模板；保持 UI/交互与 IPC 契约不变。

---

## 一、差异与目标
- 仅用 dockerode：当前大量使用 CLI（docker、docker compose）。目标：全部替换为 dockerode API。
- Orchestration 模板：当前仅有 `orchestration/infra/docker-compose.infra.yml`。目标：按 Prompt 生成 `orchestration/basic/*`、`orchestration/features/*` 的 Dockerfile 与 env.example。
- 日志：当前历史日志使用 `docker logs`，实时日志主要是操作期命令输出。目标：
  - 历史日志使用 `container.logs()` 聚合；
  - 实时日志使用 `container.attach({ stream: true })` 常驻推送到 `IPC.ModuleLogEvent`。
- 状态：当前用 `docker ps/inspect`。目标：用 `dockerode.listContainers({all:true})` + `container.inspect()` 与内存缓存实现。
- 启停/首次启动：当前依赖 compose + CLI。目标：使用注册表驱动 dockerode 的镜像拉取/构建、容器创建/启动/停止，具备依赖与健康检查。

---

## 二、分阶段实施计划
- 阶段A（最小可运行迁移）
  - 用 dockerode 重写历史日志聚合（`getModuleLogs()`）。
  - 补齐 `orchestration/basic` 与 `orchestration/features` 的 Dockerfile 与 env.example（最小可行集）。
  - 保持 UI 与 IPC 不变，验证现有事件订阅（已使用 dockerode）与状态点渲染链路正常。
- 阶段B（状态查询与 attach 实时日志）
  - 用 dockerode 重写状态查询（替换 `docker ps/inspect`）。
  - 新增“容器级实时日志 attach”与自动重连/回收；通过 `IPC.ModuleLogEvent` 推送。
- 阶段C（启停/首次启动 dockerode 化）
  - 用 dockerode 实现构建/拉取镜像、创建网络/卷、创建容器、启动/停止容器；
  - 删除 `compose-runner.ts` 及所有 CLI 调用；
  - 落实依赖、端口冲突、健康检查与“基础服务占用阻止停止”。
- 阶段D（清理与文档）
  - 清理不再需要的 CLI 工具函数与脚本；
  - 完善 README 与打包脚本说明。

---

## 三、具体代码变更点清单
- A1 日志聚合 dockerode 化
  - 文件：`src/main/docker/index.ts`
  - 函数：`getModuleLogs(name?: ModuleName, tail=200)`
  - 修改：改为使用 dockerode：按模块解析目标容器名 → `docker.getContainer(cname).logs({ stdout: true, stderr: true, timestamps: true, tail })` → 解析时间戳/级别 → 聚合排序返回。

- A2 Orchestration 目录与模板新增
  - 新增目录与文件（最小集）：
    - `orchestration/basic/postgres/Dockerfile`
    - `orchestration/basic/redis/Dockerfile`
    - `orchestration/basic/minio/Dockerfile`
    - `orchestration/basic/qdrant/Dockerfile`
    - `orchestration/basic/meilisearch/Dockerfile`
    - `orchestration/features/n8n/Dockerfile`
    - `orchestration/features/dify/web/Dockerfile`
    - `orchestration/features/dify/worker/Dockerfile`
    - 各目录按需 `env.example`

- B1 状态查询 dockerode 化
  - 文件：`src/main/docker/index.ts`
  - 函数：`getModuleStatus(name)` 与 `getDockerPsSnapshot()`、`listRunningContainerNames()`、`listAllContainerNames()` 等
  - 修改：
    - 用 `dockerode.listContainers({ all: true })` 获取快照，构建 `names→ports/states` 映射；
    - `container.inspect()` 补充状态与健康信息；
    - 保留短期缓存以减低频率；
    - 端口映射从 `NetworkSettings.Ports` 构建。

- B2 实时日志 attach 流
  - 新增：在主进程维护 `module→containers` 的 attach 管理器；
  - `container.attach({ stream:true, stdout:true, stderr:true, logs:false })` 推送到 `IPC.ModuleLogEvent`；
  - 窗口关闭时清理；容器重启时自动重连（可依赖事件订阅）。

- C1 启停/首次启动 dockerode 化
  - 文件：`src/main/docker/index.ts`、`src/main/docker/resources.ts`、`src/main/docker/template.ts`（可复用注册表）
  - 修改：
    - 镜像：`docker.pull` 或 `docker.buildImage`；
    - 网络：`docker.createNetwork`（若不存在）；
    - 卷：`docker.createVolume`（若不存在）；
    - 容器：`docker.createContainer` + `container.start/stop`；
    - 依赖：先 basic 后 feature，健康检查与端口冲突保持；
    - 删除 `compose-runner.ts` 并替换相关调用路径。

- D1 清理与文档
  - 删除/改造：`src/main/docker/utils.ts` 中 CLI 相关、`compose-runner.ts`、`template.ts`（若不再需 compose 模板可简化为容器参数生成）
  - 更新：`README.md` 与开发/构建/打包脚本说明。

---

## 四、回归与验收
- 顶部标签与首页 UI 与交互一致（含动画、悬停效果）。
- `home` 能检测 Docker，未运行可“启动 Docker”后在 60s 内刷新为运行态。
- “启动所有服务”可按依赖顺序启动，端口冲突给出明确提示，健康检查通过状态变为 running。
- 进入 `n8n/dify/oneapi/ragflow` 路由，顶部状态点实时变化。
- 关闭应用前，事件与日志流 watcher 正确清理。
- Windows 上 `electron-builder` 能打包成功。

---

## 五、实施顺序与里程碑
- 里程碑1（A阶段完成）：日志聚合 dockerode 化 + Orchestration 模板落地
- 里程碑2（B阶段完成）：状态查询 dockerode 化 + 实时日志 attach
- 里程碑3（C阶段完成）：启停/首次启动 dockerode 化，移除所有 CLI
- 里程碑4（D阶段完成）：清理与文档
